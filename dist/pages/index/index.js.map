{"version":3,"file":"pages/index/index.js","sources":["webpack:///._src_pages_index_index.js","webpack:///./src/pages/index/index.js?1f27","webpack:///._src_pages_index_index.scss"],"sourcesContent":["import { Block, View, Image, OpenData, Text, Button } from \"@tarojs/components\"\nimport React from \"react\"\nimport Taro from \"@tarojs/taro\"\nimport withWeapp from \"@tarojs/with-weapp\"\nimport \"./index.scss\"\n\n/**\n * 小程序首页\n *\n * @author: Harlan\n * @create: 2019-05-14\n */\nconst app = Taro.getApp().$app\n\n@withWeapp({\n  /**\n   * 定义数据对象\n   */\n  data: {\n    // 是否登录\n    isLogin: Taro.getStorageSync(\"user\"), //app.globalData.isLogin,\n    // 默认为空数据\n    isEmpty: true,\n    // 我的记录数据集\n    resultRows: [],\n    openId: \"\",\n    nickName: \"\",\n    score: 0,\n    userInfo: {},\n  },\n\n  /**\n   * 生命周期函数--监听页面显示\n   */\n  onShow: function() {\n    Taro.setNavigationBarTitle({\n      title: \"我的\",\n    })\n    // 当前版本不支持小程序云函数\n    if (!Taro.cloud) {\n      Taro.showModal({\n        title: \"提示\",\n        content: \"微信版本过低，请升级微信\",\n      })\n      return\n    }\n    // 查询授权\n    const thar = this\n    this.setData(\n      {\n        isLogin: Taro.getStorageSync(\"user\"),\n      },\n      () => {\n        if (!thar.data.isLogin) {\n          Taro.showModal({\n            title: \"您还未登录\",\n            content: \"登录,浏览更多\",\n            showCancel: false,\n            success: function(res) {\n              thar.getUserProfile()\n              thar.query()\n            },\n          })\n        } else {\n          thar.query()\n          thar.bindUser(JSON.parse(thar.data.isLogin))\n        }\n      }\n    )\n  },\n\n  bindgetUserInfo: function() {\n    Taro.getUserInfo({}).then((res) => {\n      this.bindUser(res.userInfo)\n      this.setData({\n        isLogin: res.userInfo,\n      })\n    })\n  },\n\n  bindUser: function(userInfo) {\n    let pages = Taro.getCurrentPages()\n    let page = pages[pages.length - 1]\n    let options = page.options\n\n    // 调用云函数\n    userInfo.env = app.globalData.env\n    userInfo.pOpenId = options.pOpenId\n    userInfo.pNickName = options.pNickName\n      ? decodeURI(options.pNickName)\n      : options.pNickName\n    Taro.cloud\n      .callFunction({\n        name: \"user\",\n        data: userInfo,\n      })\n      .then((res) => {\n        userInfo.level = res.result.level\n        this.setData({\n          openId: userInfo.openId,\n          nickName: userInfo.nickName,\n          score: userInfo.score,\n          isLogin: userInfo,\n        })\n        Taro.setStorageSync(\"user\", JSON.stringify(res.result))\n        // 隐藏loading\n        Taro.hideLoading()\n      })\n      .catch((err) => {\n        console.log(err, \"user add func err\")\n        Taro.hideLoading()\n        Taro.showModal({\n          title: \"提示\",\n          content: \"系统异常，请稍后再试\",\n        })\n      })\n  },\n\n  rad: function(d) {\n    return (d * Math.PI) / 180.0\n  },\n\n  /*\n   @param lng1 经度1\n  * @param lat1 纬度1\n  * @param lng2 经度2\n  * @param lat2 纬度2\n  * @return 距离（米）\n  */\n  getDistanceFromLatLonInKm: function(lat1, lng1, lat2, lng2) {\n    var radLat1 = (lat1 * Math.PI) / 180.0\n    var radLat2 = (lat2 * Math.PI) / 180.0\n    var a = radLat1 - radLat2\n    var b = (lng1 * Math.PI) / 180.0 - (lng2 * Math.PI) / 180.0\n    var s =\n      2 *\n      Math.asin(\n        Math.sqrt(\n          Math.pow(Math.sin(a / 2), 2) +\n            Math.cos(radLat1) * Math.cos(radLat2) * Math.pow(Math.sin(b / 2), 2)\n        )\n      )\n    s = s * 6378.137\n    s = Math.round(s * 10000) / 10\n    s = s / 1000\n    return s.toFixed(2)\n  },\n\n  query: function() {\n    // 全局显示loading\n    Taro.showLoading({\n      title: \"加载中...\",\n    })\n    // 调用云函数\n    Taro.cloud\n      .callFunction({\n        name: \"index\",\n        data: {\n          env: app.globalData.env,\n        },\n      })\n      .then((res) => {\n        var rows = res.result.data ? res.result.data : []\n        rows.map((item) => {\n          item.files = item.fileID.split(\",\")\n          item.distance = this.getDistanceFromLatLonInKm(\n            app.globalData.latitude,\n            app.globalData.longitude,\n            item.latitude,\n            item.longitude\n          )\n        })\n        // 异步回调并更新数据\n        this.setData({\n          openId: res.result.openid,\n          resultRows: rows,\n          isEmpty: rows.length > 0 ? false : true,\n        })\n        // console.log(this.data);\n        // 隐藏loading\n        Taro.hideLoading()\n      })\n      .catch((err) => {\n        console.log(err)\n        console.log(\"call INDEX func err\")\n        Taro.hideLoading()\n        Taro.showModal({\n          title: \"提示\",\n          content: \"系统异常，请稍后再试\",\n        })\n      })\n  },\n  goDetail: function(e, item, update) {\n    e.stopPropagation()\n    console.log(update, \"zhegeshi ture ba \")\n    Taro.navigateTo({\n      url:\n        \"/pages/detail/detail?id=\" +\n        item._id +\n        \"&status=\" +\n        item.status +\n        \"&sceneIndex=\" +\n        item.sceneIndex +\n        \"&openId=\" +\n        this.data.openId +\n        \"&nickName=\" +\n        this.data.nickName +\n        \"&update=\" +\n        update,\n    })\n  },\n})\nexport default class Index extends React.Component {\n  getUserProfile() {\n    Taro.getUserProfile({ desc: \"查询用户信息\" }).then((res) => {\n      this.bindUser(res.userInfo)\n    })\n  }\n\n  onShareAppMessage() {\n    let pages = Taro.getCurrentPages()\n    let page = pages[pages.length - 1]\n    return {\n      title: `闲置，转给附近需要的人`,\n      path: `/${page.route}?pOpenId=${this.data.openId}&pNickName=${this.data.nickName}`,\n    }\n  }\n\n  previewImage(e, files) {\n    e.stopPropagation()\n    Taro.previewImage({\n      current: e.currentTarget.id, // 当前显示图片的http链接\n      urls: files, // 需要预览的图片http链接列表\n    })\n  }\n  goMyInvite() {\n    Taro.navigateTo({\n      url: \"/pages/apply/apply\",\n    })\n  }\n  goBanner() {\n    Taro.navigateTo({\n      url: \"/pages/banner/banner\",\n    })\n  }\n  render() {\n    const { isLogin, resultRows, score } = this.data\n    console.log(isLogin, \"等级\")\n    return (\n      <Block>\n        {/*  列表  */}\n        <View className=\"page\">\n          {/* {!isLogin && (\n            <button\n              className=\"login-button\"\n              ref=\"loginButton\"\n              open-type=\"getUserInfo\"\n              lang=\"zh_CN\"\n              onGetUserInfo={this.bindgetUserInfo}\n            >\n              我的发布\n            </button>\n          )} */}\n          <View className=\"weui-panel\">\n            <View\n              style=\"display:flex;height: 90px;\n              align-items:center;\n              padding-left: 10px\"\n            >\n              <View style=\"width:60px;height:60px\">\n                <OpenData type=\"userAvatarUrl\" />\n              </View>\n              <View style=\"margin-left:15px;display:flex;flex-direction:column;\">\n                <OpenData type=\"userNickName\" />\n                <Text>公益积分：{score}</Text>\n              </View>\n            </View>\n            {\n              <Button onclick={this.goMyInvite} className=\"\">\n                我的邀请\n              </Button>\n            }\n            {isLogin.level && (\n              <Button\n                onclick={this.goBanner}\n                style={{ marginTop: 10, marginBottom: 10 }}\n              >\n                创建活动图\n              </Button>\n            )}\n            {resultRows.length == 0 && (\n              <View className=\"weui-panel\">\n                <View className=\"weui-loadmore weui-loadmore_line\">\n                  <View className=\"weui-loadmore__tips weui-loadmore__tips_in-line\">\n                    暂无发布\n                  </View>\n                </View>\n              </View>\n            )}\n            {/*  数据列表 [[ */}\n            {isLogin &&\n              resultRows.map((item, index) => {\n                return (\n                  <View\n                    className=\"ui-list-item\"\n                    key=\"_id\"\n                    onClick={(e) => this.goDetail(e, item)}\n                  >\n                    <View className=\"weui-media-box weui-media-box_appmsg\">\n                      <View className=\"weui-media-box__title\">\n                        {item.title}\n                      </View>\n                    </View>\n                    <View className=\"weui-media-box weui-media-box_appmsg\">\n                      <View className=\"weui-uploader__files\" id=\"uploaderFiles\">\n                        {item.files &&\n                          item.files.map((item1, index) => {\n                            if (index < 3)\n                              return (\n                                <Block key={index}>\n                                  <View\n                                    className=\"weui-uploader__file\"\n                                    onClick={(e) =>\n                                      this.previewImage(e, item.files)\n                                    }\n                                    id={item1}\n                                  >\n                                    <Image\n                                      className=\"weui-uploader__img\"\n                                      src={item1}\n                                      mode=\"aspectFill\"\n                                    ></Image>\n                                  </View>\n                                </Block>\n                              )\n                          })}\n                      </View>\n                    </View>\n                    <View className=\"weui-media-box weui-media-box_appmsg\">\n                      <View className=\"weui-media-box__desc\">\n                        {item.content}\n                        {/* {item.nickName +\n                          ' · ' +\n                          global.formatDate(formatTime(item.createTime))} */}\n                      </View>\n                      {/* <View style=\"margin-left:15px\">\n                        <View className=\"ui-like ui-font-red\">距我{item.distance}km</View>\n                      </View> */}\n                      <View\n                        className=\"ui-content\"\n                        onClick={(e) => this.goDetail(e, item, true)}\n                      >\n                        修改\n                      </View>\n                    </View>\n                  </View>\n                )\n              })}\n          </View>\n        </View>\n      </Block>\n    )\n  }\n}\n\n// export default Nearby\n","import { createPageConfig } from '@tarojs/runtime'\nimport component from \"../../../node_modules/@tarojs/mini-runner/node_modules/babel-loader/lib/index.js!./index.js\"\nvar config = {\"usingComponents\":{}};\n\ncomponent.enableShareAppMessage = true\nvar inst = Page(createPageConfig(component, 'pages/index/index', {root:{cn:[]}}, config || {}))\n\n","// extracted by mini-css-extract-plugin"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAAA;AAwMA;AArMA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAVA;AACA;AAYA;AACA;AACA;AACA;AACA;AACA;AADA;AACA;AAGA;AACA;AACA;AACA;AAFA;AAIA;AAVA;AACA;AACA;AAWA;AACA;AAEA;AADA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAPA;AADA;AAWA;AACA;AACA;AAlBA;AAlCA;AAyDA;AAAA;AACA;AAAA;AACA;AACA;AAAA;AACA;AADA;AAFA;AA1DA;AAkEA;AAAA;AACA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AAGA;AAEA;AACA;AAFA;AAKA;AACA;AAAA;AACA;AACA;AACA;AACA;AAJA;AACA;AAKA;AACA;AACA;AAfA;AAkBA;AACA;AACA;AACA;AACA;AAFA;AApBA;AA7EA;AAwGA;AACA;AAzGA;AACA;AA2GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAQA;AACA;AACA;AACA;AAnIA;AAsIA;AAAA;AACA;AACA;AAAA;AACA;AADA;AACA;AAGA;AAEA;AACA;AACA;AADA;AAFA;AAOA;AACA;AACA;AACA;AAJA;AACA;AAWA;AACA;AACA;AACA;AAHA;AAMA;AACA;AACA;AADA;AA1BA;AA6BA;AACA;AACA;AACA;AACA;AACA;AAFA;AAhCA;AA5IA;AAkLA;AACA;AACA;AACA;AACA;AADA;AAeA;AApMA;;;;;;;;;;;;;AAuMA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AADA;AAGA;;;AAEA;AACA;AACA;AACA;AACA;AACA;AAFA;AAIA;;;AAEA;AACA;AACA;AACA;AAAA;AACA;AACA;AAHA;AAIA;;;AACA;AACA;AACA;AADA;AAGA;;;AACA;AACA;AACA;AADA;AAGA;;;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AAAA;AAYA;AAAA;AAEA;AADA;AAKA;AAAA;AACA;AAAA;AADA;AAGA;AAAA;AACA;AAAA;AACA;AAAA;AAFA;AARA;AAcA;AAAA;AAAA;AAAA;AAMA;AACA;AAAA;AAAA;AAAA;AAFA;AAAA;AAQA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AADA;AADA;AAWA;AAEA;AAEA;AAAA;AAHA;AAAA;AAKA;AAAA;AACA;AAAA;AAAA;AADA;AAKA;AAAA;AACA;AAAA;AAAA;AAGA;AAEA;AAEA;AACA;AAAA;AAFA;AAKA;AALA;AAQA;AACA;AACA;AAHA;AAPA;AADA;AAHA;AAFA;AADA;AAyBA;AAAA;AACA;AAAA;AAAA;AAUA;AACA;AAAA;AAFA;AAAA;AAAA;AAVA;AAnCA;AAxCA;AAAA;AAZA;AAFA;AAiHA;;;;AAtJA;AAAA;;;;;;;;;;;;;ACpNA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACNA;;;;A","sourceRoot":""}